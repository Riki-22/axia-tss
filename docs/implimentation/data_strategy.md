# Phase 2: Redisçµ±åˆ & ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹å±¤ - è©³ç´°è¨­è¨ˆæ›¸

**ä½œæˆæ—¥**: 2025-10-15  
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: è¨­è¨ˆç¢ºå®š

---

## ğŸ“‹ ç›®æ¬¡

1. [æ¦‚è¦](#æ¦‚è¦)
2. [ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ](#ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ)
3. [TTLè¨­è¨ˆï¼ˆNYã‚¯ãƒ­ãƒ¼ã‚ºåŸºæº–ï¼‰](#ttlè¨­è¨ˆnyã‚¯ãƒ­ãƒ¼ã‚ºåŸºæº–)
4. [ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆMessagePackï¼‰](#ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆmessagepack)
5. [å®Ÿè£…ä»•æ§˜](#å®Ÿè£…ä»•æ§˜)
6. [ãƒ†ã‚¹ãƒˆæˆ¦ç•¥](#ãƒ†ã‚¹ãƒˆæˆ¦ç•¥)

---

## æ¦‚è¦

### ç›®çš„

**4å±¤ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ã«ã‚ˆã‚‹ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Šã¨å¯ç”¨æ€§ç¢ºä¿**

- Redisçµ±åˆã«ã‚ˆã‚‹24æ™‚é–“ãƒ‡ãƒ¼ã‚¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥
- MT5æ¥ç¶šç«¶åˆã®60%å‰Šæ¸›
- ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“90%æ”¹å–„ï¼ˆ100ms â†’ 10msï¼‰
- ã‚·ã‚¹ãƒ†ãƒ å¯ç”¨æ€§å‘ä¸Šï¼ˆMT5éšœå®³æ™‚ã‚‚ç¶™ç¶šç¨¼åƒï¼‰

### ä¸»è¦æˆæœç‰©

```
src/infrastructure/persistence/redis/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ redis_client.py      # æ¥ç¶šç®¡ç†ï¼ˆã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ï¼‰
â””â”€â”€ price_cache_repository.py       # OHLCVã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ­ã‚¸ãƒƒã‚¯

src/domain/repositories/
â””â”€â”€ market_data_repository.py  # ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å®šç¾©
```

---

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ

### ãƒ¬ã‚¤ãƒ¤ãƒ¼æ§‹æˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Domain Layer                                    â”‚
â”‚  â””â”€ IMarketDataRepository (ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†‘ å®Ÿè£…
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Infrastructure Layer                            â”‚
â”‚  â”œâ”€ RedisClient (æ¥ç¶šç®¡ç†)                      â”‚
â”‚  â””â”€ PriceCacheRepository (ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ­ã‚¸ãƒƒã‚¯)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ åˆ©ç”¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ElastiCache for Redis                           â”‚
â”‚  â””â”€ t4g.micro (512MB) @ $12.67/æœˆ               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è²¬å‹™åˆ†é›¢

#### RedisClientï¼ˆæ¥ç¶šç®¡ç†ï¼‰

**å½¹å‰²**: ä½ãƒ¬ãƒ™ãƒ«ãªRedisæ“ä½œã®æä¾›

```python
è²¬å‹™:
â”œâ”€ ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ã§æ¥ç¶šã‚’1ã¤ã ã‘ç¶­æŒ
â”œâ”€ æ¥ç¶šãƒ—ãƒ¼ãƒ«ç®¡ç†ï¼ˆmax_connections=10ï¼‰
â”œâ”€ ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆæœ€å¤§3å›ã€æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ï¼‰
â”œâ”€ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½
â””â”€ åŸºæœ¬æ“ä½œï¼ˆget/set/delete/exists/keysï¼‰

æä¾›ãƒ¡ã‚½ãƒƒãƒ‰:
â”œâ”€ get_instance() â†’ RedisClient
â”œâ”€ ping() â†’ bool
â”œâ”€ get(key) â†’ Optional[bytes]
â”œâ”€ set(key, value, ex) â†’ bool
â”œâ”€ delete(key) â†’ bool
â”œâ”€ exists(key) â†’ bool
â”œâ”€ keys(pattern) â†’ List[str]
â””â”€ close() â†’ None
```

#### PriceCacheRepositoryï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ­ã‚¸ãƒƒã‚¯ï¼‰

**å½¹å‰²**: OHLCVãƒ‡ãƒ¼ã‚¿å°‚ç”¨ã®é«˜ãƒ¬ãƒ™ãƒ«æ“ä½œ

```python
è²¬å‹™:
â”œâ”€ NYã‚¯ãƒ­ãƒ¼ã‚ºåŸºæº–ã®TTLç®¡ç†
â”œâ”€ MessagePackã«ã‚ˆã‚‹ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º
â”œâ”€ ã‚­ãƒ¼ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆçµ±ä¸€
â”œâ”€ ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ç›£è¦–
â””â”€ ã‚­ãƒ£ãƒƒã‚·ãƒ¥çµ±è¨ˆæƒ…å ±

æä¾›ãƒ¡ã‚½ãƒƒãƒ‰:
â”œâ”€ save_ohlcv(df, symbol, timeframe) â†’ bool
â”œâ”€ load_ohlcv(symbol, timeframe, start_date, end_date, days) â†’ Optional[DataFrame]
â”œâ”€ exists(symbol, timeframe, date) â†’ bool
â”œâ”€ get_available_range(symbol, timeframe) â†’ Optional[Tuple[datetime, datetime]]
â”œâ”€ delete(symbol, timeframe) â†’ bool
â”œâ”€ clear_symbol(symbol) â†’ int
â”œâ”€ get_memory_usage() â†’ Dict
â””â”€ get_cache_stats() â†’ Dict
```

---

## TTLè¨­è¨ˆï¼ˆNYã‚¯ãƒ­ãƒ¼ã‚ºåŸºæº–ï¼‰

### è¨­è¨ˆæ–¹é‡

**æ¡ç”¨æ–¹é‡**: ç±³å›½å¸‚å ´ã‚¯ãƒ­ãƒ¼ã‚ºï¼ˆNYã‚¯ãƒ­ãƒ¼ã‚ºï¼‰ã‚’åŸºæº–ã«ãƒ‡ãƒ¼ã‚¿ã‚’ç®¡ç†

#### ç†ç”±

```
âœ“ FXå¸‚å ´ã®å–å¼•ã‚µã‚¤ã‚¯ãƒ«ã¨æ•´åˆ
âœ“ ã€Œä»Šæ—¥ã®ãƒ‡ãƒ¼ã‚¿ã€ãŒæ˜ç¢ºã«å®šç¾©ã§ãã‚‹
âœ“ é€±æœ«ã®ç„¡é§„ãªãƒ¡ãƒ¢ãƒªä½¿ç”¨ã‚’å›é¿
âœ“ ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒè‡ªç„¶
```

### FXå¸‚å ´ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³

```
NYã‚¯ãƒ­ãƒ¼ã‚ºæ™‚åˆ»ï¼ˆæ—¥æœ¬æ™‚é–“ï¼‰:
â”œâ”€ å¤æ™‚é–“ï¼ˆ3æœˆç¬¬2æ—¥æ›œ - 11æœˆç¬¬1æ—¥æ›œï¼‰: ç¿Œæœ 06:00 JST
â””â”€ å†¬æ™‚é–“ï¼ˆ11æœˆç¬¬1æ—¥æ›œ - 3æœˆç¬¬2æ—¥æ›œï¼‰: ç¿Œæœ 07:00 JST

1é€±é–“ã®æµã‚Œ:
æ—¥æ›œ 22:00 JST   å¸‚å ´ã‚ªãƒ¼ãƒ—ãƒ³ï¼ˆã‚¦ã‚§ãƒªãƒ³ãƒˆãƒ³ï¼‰
æœˆæ›œ 06:00 JST   NYã‚¯ãƒ­ãƒ¼ã‚ºï¼ˆå‰é€±é‡‘æ›œåˆ†ï¼‰â˜…ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
ç«æ›œ 06:00 JST   NYã‚¯ãƒ­ãƒ¼ã‚ºï¼ˆæœˆæ›œåˆ†ï¼‰â˜…ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
æ°´æ›œ 06:00 JST   NYã‚¯ãƒ­ãƒ¼ã‚ºï¼ˆç«æ›œåˆ†ï¼‰â˜…ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
æœ¨æ›œ 06:00 JST   NYã‚¯ãƒ­ãƒ¼ã‚ºï¼ˆæ°´æ›œåˆ†ï¼‰â˜…ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
é‡‘æ›œ 06:00 JST   NYã‚¯ãƒ­ãƒ¼ã‚ºï¼ˆæœ¨æ›œåˆ†ï¼‰â˜…ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
åœŸæ›œ 06:00 JST   NYã‚¯ãƒ­ãƒ¼ã‚ºï¼ˆé‡‘æ›œåˆ†ï¼‰
åœŸæ›œ 07:00 JST   å¸‚å ´å®Œå…¨ã‚¯ãƒ­ãƒ¼ã‚º
  â†“ é€±æœ«ä¿æŒï¼ˆç´„40æ™‚é–“ï¼‰
æ—¥æ›œ 22:00 JST   å¸‚å ´å†ã‚ªãƒ¼ãƒ—ãƒ³
æœˆæ›œ 06:00 JST   â˜…é€±æœ«ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
```

### TTLè¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯

```python
def _calculate_ttl_until_ny_close(current_time: datetime) -> int:
    """
    ç¾åœ¨æ™‚åˆ»ã‹ã‚‰æ¬¡ã®NYã‚¯ãƒ­ãƒ¼ã‚ºã¾ã§ã®ç§’æ•°ã‚’è¨ˆç®—
    
    ä¾‹:
    - ç«æ›œ 10:00 JST â†’ æ°´æ›œ 06:00 JST = 20æ™‚é–“ = 72,000ç§’
    - ç«æ›œ 05:00 JST â†’ ç«æ›œ 06:00 JST = 1æ™‚é–“ = 3,600ç§’
    - é‡‘æ›œ 20:00 JST â†’ åœŸæ›œ 06:00 JST = 10æ™‚é–“ = 36,000ç§’
    
    é€±æœ«:
    - åœŸæ›œ 10:00 JST â†’ æœˆæ›œ 06:00 JST = ç´„44æ™‚é–“
    """
    
    # 1. å¤æ™‚é–“åˆ¤å®š
    is_dst = _is_dst(current_time)
    ny_close_hour = 6 if is_dst else 7
    
    # 2. æ¬¡ã®NYã‚¯ãƒ­ãƒ¼ã‚ºæ™‚åˆ»ã‚’è¨ˆç®—
    next_close = current_time.replace(
        hour=ny_close_hour, minute=0, second=0, microsecond=0
    )
    
    # 3. æ—¢ã«éãã¦ã„ã‚‹å ´åˆã¯ç¿Œæ—¥
    if current_time >= next_close:
        next_close += timedelta(days=1)
    
    # 4. é€±æœ«å‡¦ç†ï¼šåœŸæ›œã®å ´åˆã¯æœˆæ›œã¾ã§ä¿æŒ
    if next_close.weekday() == 5:  # åœŸæ›œ
        next_close += timedelta(days=2)  # æœˆæ›œã¾ã§
    elif next_close.weekday() == 6:  # æ—¥æ›œ
        next_close += timedelta(days=1)  # æœˆæ›œã¾ã§
    
    # 5. TTLç§’æ•°ã‚’è¨ˆç®—
    ttl_seconds = int((next_close - current_time).total_seconds())
    
    return max(ttl_seconds, 3600)  # æœ€ä½1æ™‚é–“ã¯ä¿æŒ
```

### é€±æœ«ãƒ‡ãƒ¼ã‚¿ã®æ‰±ã„

**æ¡ç”¨æ–¹é‡**: é€±æœ«ãƒ‡ãƒ¼ã‚¿ã¯æœˆæ›œã‚ªãƒ¼ãƒ—ãƒ³ã¾ã§ä¿æŒï¼ˆç´„40æ™‚é–“ï¼‰

```
åœŸæ›œ 06:00 JST ã‚¯ãƒ­ãƒ¼ã‚º
    â†“ ä¿æŒæœŸé–“ï¼ˆç´„40æ™‚é–“ï¼‰
æœˆæ›œ 06:00 JST å‰Šé™¤

ç†ç”±:
âœ“ é€±æœ«ã«åˆ†æä½œæ¥­ã‚’ã™ã‚‹å¯èƒ½æ€§ã‚’è€ƒæ…®
âœ“ ãƒ‡ãƒ¼ã‚¿ã®é€£ç¶šæ€§ã‚’ç¢ºä¿
âœ“ ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã¯è¨±å®¹ç¯„å›²å†…ï¼ˆ50MBä»¥ä¸‹ï¼‰
```

### ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°æˆ¦ç•¥

**æ¡ç”¨æ–¹é‡**: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–° + å®šæœŸã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

```
ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°:
â”œâ”€ ãƒ‡ãƒ¼ã‚¿å–å¾—ã®éƒ½åº¦ã€Redisã«ä¿å­˜
â”œâ”€ TTLã¯æ¬¡ã®NYã‚¯ãƒ­ãƒ¼ã‚ºã¾ã§è‡ªå‹•è¨ˆç®—
â””â”€ é®®åº¦ã®é«˜ã„ãƒ‡ãƒ¼ã‚¿ã‚’å¸¸ã«æä¾›

å®šæœŸã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—:
â”œâ”€ æ¯æœ 08:00 JST ã«å®Ÿè¡Œ
â”œâ”€ æœŸé™åˆ‡ã‚Œã‚­ãƒ¼ã‚’æ˜ç¤ºçš„ã«å‰Šé™¤
â””â”€ ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã‚’ç›£è¦–ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆ
```

---

## ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆMessagePackï¼‰

### æ¡ç”¨ç†ç”±

**æ¡ç”¨æ–¹é‡**: MessagePackã‚’ä½¿ç”¨ã—ã¦DataFrameã‚’ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º

#### pickleã¨æ¯”è¼ƒã—ãŸå„ªä½æ€§

| é …ç›® | pickle | MessagePack | åˆ¤å®š |
|------|--------|-------------|------|
| **é€Ÿåº¦** | é«˜é€Ÿ | éå¸¸ã«é«˜é€Ÿ | âœ“ |
| **ã‚µã‚¤ã‚º** | ä¸­ç¨‹åº¦ | å°ã•ã„ | âœ“ |
| **è¨€èªé–“äº’æ›æ€§** | Pythonå°‚ç”¨ | å¤šè¨€èªå¯¾å¿œ | âœ“ |
| **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£** | ä½ï¼ˆä»»æ„ã‚³ãƒ¼ãƒ‰å®Ÿè¡Œãƒªã‚¹ã‚¯ï¼‰ | é«˜ï¼ˆãƒ‡ãƒ¼ã‚¿ã®ã¿ï¼‰ | âœ“ |
| **ãƒ‡ãƒãƒƒã‚°** | ãƒã‚¤ãƒŠãƒªï¼ˆä¸å¯èª­ï¼‰ | ãƒã‚¤ãƒŠãƒªï¼ˆä¸å¯èª­ï¼‰ | - |
| **pandasäº’æ›æ€§** | ãƒã‚¤ãƒ†ã‚£ãƒ– | ãƒ©ã‚¤ãƒ–ãƒ©ãƒªçµŒç”± | âœ“ |

#### å…·ä½“çš„ãªãƒ¡ãƒªãƒƒãƒˆ

```python
1. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
   - ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º: pickleæ¯”ã§ç´„20%é«˜é€Ÿ
   - ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º: pickleæ¯”ã§ç´„15%é«˜é€Ÿ
   - ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚º: pickleæ¯”ã§ç´„10-20%å‰Šæ¸›

2. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
   - pickleã¯ä»»æ„ã®Pythonã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å¾©å…ƒå¯èƒ½
   - MessagePackã¯ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®ã¿ï¼ˆå®‰å…¨ï¼‰

3. å°†æ¥ã®æ‹¡å¼µæ€§
   - ä»–è¨€èªï¼ˆGo, Rustãªã©ï¼‰ã‹ã‚‰ã‚‚ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
   - ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹åŒ–ã«å¯¾å¿œ

4. æ¨™æº–åŒ–
   - æ¥­ç•Œæ¨™æº–ã®ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
   - å¤šãã®ãƒ„ãƒ¼ãƒ«ã§å¯¾å¿œ
```

### å®Ÿè£…æ–¹æ³•

```python
import msgpack
import pandas as pd
import numpy as np

def serialize_dataframe(df: pd.DataFrame) -> bytes:
    """
    DataFrameã‚’MessagePackå½¢å¼ã«ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º
    
    Args:
        df: OHLCV DataFrame
            - index: DatetimeIndex (UTC)
            - columns: ['open', 'high', 'low', 'close', 'volume']
    
    Returns:
        bytes: MessagePackå½¢å¼ã®ãƒã‚¤ãƒŠãƒªãƒ‡ãƒ¼ã‚¿
    
    Note:
        - indexã®datetimeã‚’UNIXã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—(ç§’)ã«å¤‰æ›
        - åˆ—æŒ‡å‘ã®è¾æ›¸å½¢å¼ã§ä¿å­˜ï¼ˆåœ§ç¸®åŠ¹ç‡ãŒè‰¯ã„ï¼‰
    """
    df_copy = df.copy()
    
    # DatetimeIndexã‚’UNIXã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ï¼ˆç§’å˜ä½ï¼‰ã«å¤‰æ›
    if isinstance(df_copy.index, pd.DatetimeIndex):
        df_copy.index = df_copy.index.astype(np.int64) // 10**9
    
    # åˆ—æŒ‡å‘ã®è¾æ›¸ã«å¤‰æ›ï¼ˆ'time'åˆ—ã‚’å«ã‚€ï¼‰
    data_to_pack = df_copy.reset_index().to_dict('list')
    
    return msgpack.packb(data_to_pack, use_bin_type=True)


def deserialize_dataframe(data: bytes) -> pd.DataFrame:
    """
    MessagePackå½¢å¼ã‹ã‚‰DataFrameã‚’å¾©å…ƒ
    
    Args:
        data: MessagePackå½¢å¼ã®ãƒã‚¤ãƒŠãƒªãƒ‡ãƒ¼ã‚¿
    
    Returns:
        pd.DataFrame: OHLCV DataFrame
            - index: DatetimeIndex (UTC)
            - columns: ['open', 'high', 'low', 'close', 'volume']
    
    Raises:
        ValueError: ãƒ‡ãƒ¼ã‚¿ãŒä¸æ­£ãªå½¢å¼ã®å ´åˆ
    """
    try:
        unpacked_data = msgpack.unpackb(data, raw=False)
        
        # DataFrameã«å¾©å…ƒ
        df = pd.DataFrame(unpacked_data)
        
        # 'time'åˆ—ã¾ãŸã¯'index'åˆ—ã‚’ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«è¨­å®š
        time_col = 'time' if 'time' in df.columns else 'index'
        df = df.set_index(time_col)
        
        # UNIXã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‹ã‚‰datetimeã«å¾©å…ƒï¼ˆUTCï¼‰
        df.index = pd.to_datetime(df.index, unit='s', utc=True)
        df.index.name = 'time'
        
        # æ•°å€¤å‹ã‚’æ˜ç¤ºçš„ã«è¨­å®šï¼ˆå¿µã®ãŸã‚ï¼‰
        for col in ['open', 'high', 'low', 'close']:
            if col in df.columns:
                df[col] = df[col].astype(np.float64)
        if 'volume' in df.columns:
            df[col] = df['volume'].astype(np.int64)
        
        return df
        
    except Exception as e:
        raise ValueError(f"Failed to deserialize DataFrame: {e}")

### ãƒ¡ãƒ¢ãƒªåŠ¹ç‡

```
1é€šè²¨ãƒšã‚¢ Ã— 1ã‚¿ã‚¤ãƒ ãƒ•ãƒ¬ãƒ¼ãƒ  Ã— 24æ™‚é–“ï¼ˆH1ï¼‰ã®å ´åˆ:

DataFrame (ãƒ¡ãƒ¢ãƒªä¸Š):
  24æœ¬ Ã— 6ã‚«ãƒ©ãƒ  Ã— 8ãƒã‚¤ãƒˆï¼ˆfloat64ï¼‰ = ç´„1.2KB

MessagePack (Redis):
  ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ + ãƒ‡ãƒ¼ã‚¿ = ç´„0.8KBï¼ˆç´„33%å‰Šæ¸›ï¼‰

3é€šè²¨ãƒšã‚¢ Ã— 3ã‚¿ã‚¤ãƒ ãƒ•ãƒ¬ãƒ¼ãƒ  Ã— 1,440æœ¬ï¼ˆM1ï¼‰:
  ç´„1.3MBï¼ˆãƒ¡ãƒ¢ãƒªä¸Šï¼‰
  ç´„0.9MBï¼ˆMessagePackï¼‰

ç›®æ¨™: 50MBä»¥å†…
å®Ÿæ¸¬è¦‹è¾¼ã¿: ç´„30-35MB
```

---

## å®Ÿè£…ä»•æ§˜

### ã‚­ãƒ¼ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ

**æ¡ç”¨æ–¹é‡**: æ—¥ä»˜ã‚’å«ã¾ãªã„å˜ä¸€ã‚­ãƒ¼ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ

```
ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ:
  ohlcv:{symbol}:{timeframe}

ä¾‹:
  ohlcv:USDJPY:H1
  ohlcv:EURUSD:M15
  ohlcv:GBPJPY:D1

ç†ç”±:
âœ“ ã‚·ãƒ³ãƒ—ãƒ«ã§ç†è§£ã—ã‚„ã™ã„
âœ“ 1é€šè²¨ãƒšã‚¢Ã—1ã‚¿ã‚¤ãƒ ãƒ•ãƒ¬ãƒ¼ãƒ ã¯å¸¸ã«æœ€æ–°24æ™‚é–“åˆ†
âœ“ TTLã§è‡ªå‹•å‰Šé™¤ã•ã‚Œã‚‹ãŸã‚è¤‡æ•°æ—¥ç®¡ç†ä¸è¦
âœ“ ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒã§æŸ”è»Ÿãªæ“ä½œãŒå¯èƒ½

ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒä¾‹:
  keys("ohlcv:USDJPY:*")  â†’ USDJPYã®å…¨ã‚¿ã‚¤ãƒ ãƒ•ãƒ¬ãƒ¼ãƒ 
  keys("ohlcv:*:H1")      â†’ å…¨é€šè²¨ãƒšã‚¢ã®H1
  keys("ohlcv:*")         â†’ å…¨OHLCVãƒ‡ãƒ¼ã‚¿
```

### ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ç®¡ç†

```python
å„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä»˜éšã™ã‚‹ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ï¼ˆåˆ¥ã‚­ãƒ¼ã§ä¿å­˜ï¼‰:

ohlcv:USDJPY:H1          â† å®Ÿãƒ‡ãƒ¼ã‚¿ï¼ˆMessagePackï¼‰
ohlcv:USDJPY:H1:meta     â† ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ï¼ˆJSONï¼‰
  â”œâ”€ trading_day: "20251015"
  â”œâ”€ cached_at: "2025-10-15T10:30:00Z"
  â”œâ”€ data_start: "2025-10-14T10:00:00Z"
  â”œâ”€ data_end: "2025-10-15T10:00:00Z"
  â”œâ”€ row_count: 24
  â””â”€ ttl_expires_at: "2025-10-16T06:00:00Z"
```

### ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

```python
ã‚¨ãƒ©ãƒ¼ç¨®åˆ¥ã¨å¯¾å¿œ:

1. ConnectionErrorï¼ˆæ¥ç¶šã‚¨ãƒ©ãƒ¼ï¼‰
   - ãƒªãƒˆãƒ©ã‚¤3å›ï¼ˆæŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•: 1ç§’, 2ç§’, 4ç§’ï¼‰
   - å¤±æ•—æ™‚ã¯ãƒ­ã‚°è¨˜éŒ²ã—ã¦Noneã‚’è¿”ã™
   - ä¸Šä½å±¤ã§ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆMT5 â†’ S3 â†’ yfinanceï¼‰

2. TimeoutErrorï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼‰
   - socket_timeout=5ç§’
   - ãƒªãƒˆãƒ©ã‚¤ãªã—ã§Noneã‚’è¿”ã™
   - ä¸Šä½å±¤ã§ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯

3. DataErrorï¼ˆãƒ‡ãƒ¼ã‚¿ç ´æï¼‰
   - MessagePack unpackå¤±æ•—
   - è©²å½“ã‚­ãƒ¼ã‚’å‰Šé™¤
   - ãƒ­ã‚°ã«ERRORè¨˜éŒ²
   - Noneã‚’è¿”ã™

4. MemoryErrorï¼ˆãƒ¡ãƒ¢ãƒªä¸è¶³ï¼‰
   - å¤ã„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤ï¼ˆLRUçš„ã«ï¼‰
   - CloudWatchã‚¢ãƒ©ãƒ¼ãƒˆé€ä¿¡
   - å‡¦ç†ã‚’ç¶™ç¶šï¼ˆè‡´å‘½çš„ã‚¨ãƒ©ãƒ¼ã¨ã—ãªã„ï¼‰
```

### ç›£è¦–ãƒ»çµ±è¨ˆæƒ…å ±

```python
get_cache_stats() ãŒè¿”ã™æƒ…å ±:

{
    "total_keys": 15,
    "symbols": ["USDJPY", "EURUSD", "GBPJPY"],
    "timeframes": ["H1", "M15", "D1"],
    "memory_used_mb": 35.2,
    "memory_limit_mb": 50.0,
    "memory_usage_pct": 70.4,
    "oldest_data": "2025-10-14T06:00:00Z",
    "newest_data": "2025-10-15T10:30:00Z",
    "cache_hit_rate": 0.65,  # 65%
    "total_requests": 1000,
    "cache_hits": 650,
    "cache_misses": 350
}
```

---

## ãƒ†ã‚¹ãƒˆæˆ¦ç•¥

### å˜ä½“ãƒ†ã‚¹ãƒˆï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒï¼‰

```python
# test_redis_client.py
def test_singleton_pattern():
    """ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ãƒ†ã‚¹ãƒˆ"""
    client1 = RedisClient.get_instance()
    client2 = RedisClient.get_instance()
    assert client1 is client2

def test_connection_retry():
    """ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯ã®ãƒ†ã‚¹ãƒˆ"""
    # Redisã‚’ä¸€æ™‚åœæ­¢ã—ã¦ãƒ†ã‚¹ãƒˆ
    pass

def test_basic_operations():
    """åŸºæœ¬æ“ä½œã®ãƒ†ã‚¹ãƒˆ"""
    client = RedisClient.get_instance()
    assert client.set("test_key", b"test_value", ex=60)
    assert client.get("test_key") == b"test_value"
    assert client.exists("test_key")
    assert client.delete("test_key")
    assert not client.exists("test_key")
```

```python
# test_price_cache_repository.py
def test_save_load_ohlcv():
    """OHLCVä¿å­˜ãƒ»èª­ã¿è¾¼ã¿ã®ãƒ†ã‚¹ãƒˆ"""
    cache = PriceCacheRepository()
    df = create_test_dataframe()
    
    assert cache.save_ohlcv(df, "USDJPY", "H1")
    loaded = cache.load_ohlcv("USDJPY", "H1")
    
    assert loaded is not None
    assert len(loaded) == len(df)
    pd.testing.assert_frame_equal(loaded, df)

def test_ttl_calculation():
    """TTLè¨ˆç®—ã®ãƒ†ã‚¹ãƒˆ"""
    # ç«æ›œ 10:00 JST ã®å ´åˆ
    current = datetime(2025, 10, 14, 10, 0, 0)
    ttl = cache._calculate_ttl_until_ny_close(current)
    assert 19 * 3600 < ttl < 21 * 3600  # ç´„20æ™‚é–“

def test_dst_detection():
    """å¤æ™‚é–“åˆ¤å®šã®ãƒ†ã‚¹ãƒˆ"""
    summer = datetime(2025, 7, 1)
    winter = datetime(2025, 1, 1)
    assert cache._is_dst(summer) == True
    assert cache._is_dst(winter) == False

def test_weekend_handling():
    """é€±æœ«ãƒ‡ãƒ¼ã‚¿ã®ãƒ†ã‚¹ãƒˆ"""
    # é‡‘æ›œ 20:00 JST â†’ æœˆæ›œ 06:00 JST
    friday = datetime(2025, 10, 17, 20, 0, 0)
    ttl = cache._calculate_ttl_until_ny_close(friday)
    assert 58 * 3600 < ttl < 62 * 3600  # ç´„60æ™‚é–“
```

### çµ±åˆãƒ†ã‚¹ãƒˆï¼ˆEC2ç’°å¢ƒï¼‰

```python
def test_full_integration():
    """ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ã®ãƒ†ã‚¹ãƒˆ"""
    # 1. MT5ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å–å¾—
    df = mt5_collector.fetch_ohlcv_data("USDJPY", "H1", 24)
    
    # 2. Redisã«ä¿å­˜
    cache = PriceCacheRepository()
    assert cache.save_ohlcv(df, "USDJPY", "H1")
    
    # 3. Redisã‹ã‚‰èª­ã¿è¾¼ã¿
    cached = cache.load_ohlcv("USDJPY", "H1")
    assert cached is not None
    
    # 4. ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ç¢ºèª
    pd.testing.assert_frame_equal(df, cached)
    
    # 5. TTLç¢ºèª
    ttl = cache.redis_client.ttl("ohlcv:USDJPY:H1")
    assert ttl > 0

def test_performance_benchmark():
    """ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ"""
    cache = PriceCacheRepository()
    
    # ä¿å­˜é€Ÿåº¦æ¸¬å®š
    start = time.time()
    for i in range(100):
        cache.save_ohlcv(test_df, "USDJPY", "H1")
    save_time = time.time() - start
    assert save_time < 1.0  # 100å›ã§1ç§’ä»¥å†…
    
    # èª­ã¿è¾¼ã¿é€Ÿåº¦æ¸¬å®š
    start = time.time()
    for i in range(100):
        cache.load_ohlcv("USDJPY", "H1")
    load_time = time.time() - start
    assert load_time < 0.5  # 100å›ã§0.5ç§’ä»¥å†…
```

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›®æ¨™

| æŒ‡æ¨™ | ç›®æ¨™å€¤ | æ¸¬å®šæ–¹æ³• |
|------|--------|----------|
| **ä¿å­˜é€Ÿåº¦** | < 10ms | 1å›ã® save_ohlcv() |
| **èª­ã¿è¾¼ã¿é€Ÿåº¦** | < 5ms | 1å›ã® load_ohlcv() |
| **ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡** | < 50MB | get_memory_usage() |
| **ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆç‡** | > 60% | get_cache_stats() |
| **TTLç²¾åº¦** | Â±1åˆ†ä»¥å†… | NYã‚¯ãƒ­ãƒ¼ã‚ºæ™‚åˆ»ã¨ã®èª¤å·® |

---

## å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### Week 1: RedisåŸºç›¤å®Ÿè£…

- [ ] `redis_client.py` å®Ÿè£…
  - [ ] ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³
  - [ ] æ¥ç¶šãƒ—ãƒ¼ãƒ«è¨­å®š
  - [ ] ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯
  - [ ] åŸºæœ¬æ“ä½œãƒ¡ã‚½ãƒƒãƒ‰
  - [ ] ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
  - [ ] å˜ä½“ãƒ†ã‚¹ãƒˆ

- [ ] `price_cache_repository.py` å®Ÿè£…
  - [ ] NYã‚¯ãƒ­ãƒ¼ã‚ºTTLè¨ˆç®—
  - [ ] å¤æ™‚é–“åˆ¤å®š
  - [ ] MessagePackã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º
  - [ ] save_ohlcv() / load_ohlcv()
  - [ ] ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ç®¡ç†
  - [ ] çµ±è¨ˆæƒ…å ±æ©Ÿèƒ½
  - [ ] å˜ä½“ãƒ†ã‚¹ãƒˆ

- [ ] `__init__.py` ä½œæˆ

### Week 2: çµ±åˆãƒ†ã‚¹ãƒˆ

- [ ] EC2ç’°å¢ƒã§ã®å‹•ä½œç¢ºèª
- [ ] MT5é€£æºãƒ†ã‚¹ãƒˆ
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
- [ ] ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡æ¸¬å®š
- [ ] TTLå‹•ä½œç¢ºèªï¼ˆé€±æœ«å«ã‚€ï¼‰

### Week 3: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [ ] ADR-006æ›´æ–°
- [ ] READMEæ›´æ–°
- [ ] é‹ç”¨æ‰‹é †æ›¸ä½œæˆ

---

## ä»˜éŒ²

### è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆredis_config.pyï¼‰

```python
# NYã‚¯ãƒ­ãƒ¼ã‚ºæ™‚åˆ»è¨­å®š
NY_CLOSE_HOUR_EDT = 6  # å¤æ™‚é–“: JST 06:00
NY_CLOSE_HOUR_EST = 7  # å†¬æ™‚é–“: JST 07:00

# é€±æœ«ãƒ‡ãƒ¼ã‚¿ä¿æŒ
WEEKEND_RETENTION_HOURS = 40

# ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
CACHE_CLEANUP_HOUR = 8  # æ¯æœ8æ™‚

# MessagePackè¨­å®š
MSGPACK_USE_BIN_TYPE = True
```

### ä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒª

```
redis==5.0.0
msgpack==1.0.7
pandas==2.1.0
pytz==2023.3
```

---

**END OF DOCUMENT**