# 品質保証・運用

**Document Path**: `docs/basic_design/07_operations.md`  
**Version**: 2.0  
**Type**: 品質保証・運用設計書

---
## 目次

- [品質保証・運用](#品質保証運用)
  - [目次](#目次)
  - [7. 品質保証](#7-品質保証)
    - [7.1 性能要件](#71-性能要件)
      - [7.1.1 応答時間](#711-応答時間)
      - [7.1.2 スループット](#712-スループット)
      - [7.1.3 リソース使用率](#713-リソース使用率)
    - [7.2 可用性・運用要件](#72-可用性運用要件)
      - [7.2.1 稼働率目標](#721-稼働率目標)
      - [7.2.2 障害復旧時間](#722-障害復旧時間)
      - [7.2.3 保守性・拡張性](#723-保守性拡張性)
    - [7.3 セキュリティ要件](#73-セキュリティ要件)
      - [7.3.1 認証・認可](#731-認証認可)
      - [7.3.2 データ暗号化](#732-データ暗号化)
      - [7.3.3 監査ログ](#733-監査ログ)
    - [7.4 テスト戦略](#74-テスト戦略)
      - [7.4.1 単体テストカバレッジ](#741-単体テストカバレッジ)
      - [7.4.2 統合テスト](#742-統合テスト)
      - [7.4.3 パフォーマンステスト](#743-パフォーマンステスト)
      - [7.4.4 回帰テスト](#744-回帰テスト)
  - [8. 運用](#8-運用)
    - [8.1 デプロイメント](#81-デプロイメント)
      - [8.1.1 デプロイ手順](#811-デプロイ手順)
      - [8.1.2 環境別設定](#812-環境別設定)
      - [8.1.3 ロールバック手順](#813-ロールバック手順)
    - [8.2 監視とアラート](#82-監視とアラート)
      - [8.2.1 監視項目](#821-監視項目)
      - [8.2.2 アラート設定](#822-アラート設定)
      - [8.2.3 ダッシュボード](#823-ダッシュボード)
      - [8.2.4 Slack通知運用](#824-slack通知運用)
    - [8.3 障害対応](#83-障害対応)
      - [8.3.1 障害レベル定義](#831-障害レベル定義)
      - [8.3.2 復旧手順](#832-復旧手順)
    - [8.4 バックアップ・リストア](#84-バックアップリストア)
      - [8.4.1 バックアップ戦略](#841-バックアップ戦略)
      - [8.4.2 リストア手順](#842-リストア手順)
    - [8.5 容量計画](#85-容量計画)
      - [8.5.1 成長予測](#851-成長予測)
      - [8.5.2 スケーリング戦略](#852-スケーリング戦略)

## 7. 品質保証

### 7.1 性能要件

#### 7.1.1 応答時間

- **シグナル生成**: 500ms以内（10シグナル並列処理）
- **取引決定**: 1秒以内（シグナル統合〜注文実行）
- **データ更新**: 100ms以内（Redis読み書き）
- **バックテスト**: 10分以内（1年間データ処理）

#### 7.1.2 スループット

- **リアルタイム処理**: 100 ticks/秒
- **バッチ処理**: 1万レコード/分
- **API処理**: 10 リクエスト/秒

#### 7.1.3 リソース使用率

- **CPU使用率**: 平均70%以下、ピーク85%以下
- **メモリ使用率**: 平均80%以下
- **ディスク使用率**: 90%以下

### 7.2 可用性・運用要件

#### 7.2.1 稼働率目標

- **目標**: 99.5%（月間約3.6時間のダウンタイム許容）
- **計画メンテナンス**: 月次1回、最大2時間
- **障害復旧**: CloudWatchアラーム自動再起動による迅速復旧

#### 7.2.2 障害復旧時間

- **自動復旧**: 5分以内（EC2自動再起動）
- **手動復旧**: 30分以内（重大障害時）
- **データ復旧**: 1時間以内（バックアップからの復元）

#### 7.2.3 保守性・拡張性

クリーンアーキテクチャとDDD採用による高い保守性・拡張性確保。

### 7.3 セキュリティ要件

#### 7.3.1 認証・認可

- **機密情報管理**: Secrets Manager活用による安全管理
- **アクセス制御**: IAMロールベースの最小権限アクセス
- **監査ログ**: CloudTrail活用による完全追跡

#### 7.3.2 データ暗号化

- **保存時暗号化**: S3 SSE-S3、DynamoDB暗号化
- **転送時暗号化**: TLS 1.3による通信暗号化
- **キー管理**: AWS KMSによる暗号化キー管理

#### 7.3.3 監査ログ

- **API呼び出し**: CloudTrail全記録
- **データアクセス**: S3 Access Logging
- **認証情報アクセス**: Secrets Manager監査ログ

### 7.4 テスト戦略

#### 7.4.1 単体テストカバレッジ

- **目標**: ドメイン層95%以上
- **フレームワーク**: pytest、unittest
- **モック**: 外部依存関係のモック化

#### 7.4.2 統合テスト

- **MT5連携テスト**: デモ口座での実際の取引テスト
- **データフローテスト**: エンドツーエンドデータ処理検証
- **キャッシュ一貫性テスト**: Redis/DynamoDB間の整合性確認

#### 7.4.3 パフォーマンステスト

- **負荷テスト**: 想定トラフィックの2倍での動作確認
- **ストレステスト**: リソース限界での動作検証
- **耐久テスト**: 24時間連続動作テスト

#### 7.4.4 回帰テスト

- **自動化**: CI/CDパイプラインでの自動実行
- **テストデータ**: 過去の市場データでの検証
- **機能テスト**: 主要機能の動作確認

## 8. 運用

### 8.1 デプロイメント

#### 8.1.1 デプロイ手順

**本番デプロイフロー**:
1. コード変更のコミット・プッシュ
2. 自動テスト実行（GitHub Actions）
3. EC2インスタンスへのデプロイ
4. サービス再起動
5. ヘルスチェック確認
6. Slack通知

#### 8.1.2 環境別設定

- **開発環境**: ローカル・SageMaker（デモ口座）
- **ステージング環境**: EC2 t4g.micro（デモ口座）
- **本番環境**: EC2 t4g.small（本番口座）

#### 8.1.3 ロールバック手順

1. 前バージョンのDockerイメージ特定
2. サービス停止
3. 前バージョンへの切り戻し
4. サービス再起動・確認
5. 問題報告・調査

### 8.2 監視とアラート

#### 8.2.1 監視項目

**システムヘルス**:
- EC2 CPU・メモリ・ディスク使用率
- Redis接続数・メモリ使用率
- DynamoDB読み書きキャパシティ
- Lambda実行回数・エラー率

**ビジネスメトリクス**:
- アクティブポジション数
- 現在損益
- MT5接続ステータス
- システムハートビート

#### 8.2.2 アラート設定

**クリティカル（即時対応）**:
- EC2 CPU 80%以上 5分継続
- MT5接続断 1分継続
- Kill Switch発動
- システムハートビート 5分途絶

**警告（監視強化）**:
- Redis FreeableMemory 100MB以下
- Lambda Error発生
- 異常な取引パフォーマンス

#### 8.2.3 ダッシュボード

CloudWatchダッシュボードによる主要メトリクス・ログ一元可視化。

**表示項目**:
- システム稼働状況
- 取引パフォーマンス
- リソース使用状況
- エラーログ一覧

#### 8.2.4 Slack通知運用

Lambda経由疎結合Slack通知による迅速な状況把握。

**通知内容**:
- システム起動・停止
- 取引実行結果
- アラート発生
- パフォーマンス日次サマリー

### 8.3 障害対応

#### 8.3.1 障害レベル定義

**レベル1（重大）**: 全取引停止、データ消失
- 対応時間: 1時間以内
- エスカレーション: 即座

**レベル2（高）**: 部分的機能停止、パフォーマンス劣化
- 対応時間: 4時間以内
- エスカレーション: 2時間後

**レベル3（中）**: 軽微な機能影響
- 対応時間: 24時間以内
- エスカレーション: 8時間後

#### 8.3.2 復旧手順

**標準復旧フロー**:
1. 問題の特定・切り分け
2. 一時的な回避策の実施
3. 根本原因の調査・修正
4. テスト・検証
5. 本格復旧
6. 事後分析・改善策検討

### 8.4 バックアップ・リストア

#### 8.4.1 バックアップ戦略

**DynamoDB**:
- ポイントインタイムリカバリ（35日間）
- 日次バックアップ（90日間保持）

**S3**:
- バージョニング有効
- クロスリージョンレプリケーション

**Redis**:
- AOF + RDBスナップショット
- 日次バックアップ保存

#### 8.4.2 リストア手順

1. 復旧対象時点の特定
2. システム停止・メンテナンスモード
3. バックアップデータからのリストア
4. データ整合性チェック
5. システム再起動・検証

### 8.5 容量計画

#### 8.5.1 成長予測

- **データ増加**: 月間10GB（市場データ + 取引ログ）
- **トラフィック増加**: 年間20%増
- **機能拡張**: 新通貨ペア・指標追加

#### 8.5.2 スケーリング戦略

**垂直スケーリング**: EC2インスタンスタイプの変更
**水平スケーリング**: 将来的なマルチインスタンス構成
**ストレージスケーリング**: S3の自動拡張、DynamoDBオンデマンドモード